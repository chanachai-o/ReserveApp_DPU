<app-page-header [title]="'บริการหน้าร้าน'" [activeTitle]="'พนักงานเสิร์ฟ'" [title1]="'บริการหน้าร้าน'"></app-page-header>

<!-- Filter Bar -->
<div class="filter-bar">
  <div class="filter-bar__body">
    <ng-select class="filter-bar__select" [(ngModel)]="tableType" placeholder="ประเภท" (change)="onTypeChange()">
      <ng-option value="">ทั้งหมด</ng-option>
      <ng-option value="tables">โต๊ะ</ng-option>
      <ng-option value="room">ห้องประชุม</ng-option>
    </ng-select>
    <input type="date" class="filter-bar__date" [(ngModel)]="filterDate" (change)="onDateChange()" [max]="maxDate" placeholder="เลือกวันที่">
    <button class="filter-bar__clear" (click)="clearFilter()">
      <i class="ri-close-line"></i> ล้างตัวกรอง
    </button>
  </div>
</div>

<!-- Kanban Board -->
<div class="kanban-board">
  <!-- 1. ว่าง -->
  <div class="kanban-column kanban-column--available">
    <div class="kanban-column__header">
      <span><i class="ri-checkbox-blank-circle-fill"></i> ว่าง ({{ filteredAvailable.length }})</span>
    </div>
    <div class="kanban-column__body">
      <app-available-table-card *ngFor="let available of filteredAvailable"
        [item]="available"
        (openTable)="handleOpenTable($event)"
        (reserveTable)="handleReserveTable($event)">
      </app-available-table-card>
      <div *ngIf="filteredAvailable.length === 0" class="kanban-empty">ไม่มีโต๊ะ/ห้องว่าง</div>
    </div>
  </div>
  <!-- 2. มีการจอง -->
  <div class="kanban-column kanban-column--reserved">
    <div class="kanban-column__header">
      <span><i class="ri-reserved-line"></i> มีการจอง ({{ reservationList.length }})</span>
    </div>
    <div class="kanban-column__body">
      <app-reservation-card *ngFor="let res of reservationList"
        [reservation]="res"
        (checkIn)="handleCheckIn($event)"
        (cancel)="handleCancel($event)">
      </app-reservation-card>
      <div *ngIf="reservationList.length === 0" class="kanban-empty">ไม่มีการจอง</div>
    </div>
  </div>
  <!-- 3. มีลูกค้า -->
  <div class="kanban-column kanban-column--active">
    <div class="kanban-column__header">
      <span><i class="ri-login-circle-line"></i> มีลูกค้า ({{ activeTableList.length }})</span>
    </div>
    <div class="kanban-column__body">
      <app-customer-card *ngFor="let item of activeTableList"
        [occupied]="item"
        (order)="onOrder($event)"
        (bill)="onBill($event)">
      </app-customer-card>
      <div *ngIf="activeTableList.length === 0" class="kanban-empty">ไม่มีลูกค้าเข้าใช้</div>
    </div>
  </div>
  <!-- 4. ชำระเงิน -->
  <div class="kanban-column kanban-column--payment">
    <div class="kanban-column__header">
      <span><i class="ri-exchange-dollar-line"></i> ชำระเงิน ({{ paymentList.length }})</span>
    </div>
    <div class="kanban-column__body">
      <app-payment-card *ngFor="let pay of paymentList"
        [checkout]="pay"
        (viewBill)="onViewBill($event)"
        (verifyPayment)="onVerifyPayment($event)">
      </app-payment-card>
      <div *ngIf="paymentList.length === 0" class="kanban-empty">ยังไม่มีโต๊ะ/ห้องที่รอชำระ</div>
    </div>
  </div>
</div>
<div id="add-check-in" class="hs-overlay hidden ti-modal z-50">
  <div
    class="hs-overlay-open:mt-7 ti-modal-box mt-0 ease-out rounded-2xl shadow-2xl max-w-md w-full mx-auto bg-white dark:bg-neutral-900 border border-gray-100 dark:border-neutral-800">
    <div class="ti-modal-content">
      <div
        class="ti-modal-header flex justify-between items-center p-6 pb-2 border-b border-gray-100 dark:border-neutral-800 rounded-t-2xl bg-gradient-to-r from-green-100/60 via-white/80 to-white/80 dark:from-neutral-800 dark:to-neutral-900">
        <h6 class="modal-title text-lg font-bold text-green-600 dark:text-white tracking-wide" id="mail-ComposeLabel">
          <i class="ri-login-circle-line mr-2 text-green-400"></i>
          Check-In
        </h6>
        <button type="button" class="hover:bg-gray/90 dark:hover:bg-neutral-800 rounded-full p-2 ml-2 transition"
          data-hs-overlay="#add-check-in">
          <i class="ri-close-line text-2xl text-gray-500 dark:text-white"></i>
        </button>
      </div>
      <div class="ti-modal-body px-6 py-6 !overflow-visible">
        <app-table-reservation [tableId]="selectedTable?.type === 'table' ? selectedTable?.id : 0"
          [roomId]="selectedTable?.type === 'room' ? selectedTable?.id : 0" [type]="selectedTable?.type"
          [status]="'CHECKED_IN'" (reserve)="checkInTable($event)">
        </app-table-reservation>
      </div>
    </div>
  </div>
</div>
<!-- Order Modal -->
<div id="add-order" class="hs-overlay hidden ti-modal z-50">
  <div
    class="hs-overlay-open:mt-7 ti-modal-box mt-0 ease-out lg:!max-w-4xl lg:w-full m-3 lg:!mx-auto border border-gray-100">
    <div class="ti-modal-content">
      <div
        class="ti-modal-header flex justify-between items-center p-6 pb-2 border-b border-gray-100 dark:border-neutral-800 rounded-t-2xl bg-gradient-to-r from-pink-100/60 via-white/80 to-white/80 dark:from-neutral-800 dark:to-neutral-900">
        <h6 class="modal-title text-lg font-bold text-pink-600 dark:text-white" id="mail-ComposeLabel">
          <i class="ri-restaurant-2-line mr-2 text-pink-400"></i>
          สั่งอาหาร
        </h6>
        <button type="button" class="hover:bg-gray-200 dark:hover:bg-neutral-800 rounded-full p-2 ml-2 transition"
          data-hs-overlay="#add-order">
          <i class="ri-close-line text-2xl text-gray-500 dark:text-white"></i>
        </button>
      </div>
      <div class="ti-modal-body px-6 py-6 !overflow-visible">
        <app-order-food [userId]="reservation?.user_id!" [reservationId]="reservation?.id!"
          [orderItems]="reservation?.orders?.length ? (reservation?.orders![0].order_items || []) : []"
          (submitOrder)="handleOrder($event)"
          [isStaff]="true">
        </app-order-food>

      </div>
    </div>
  </div>
</div>
<!-- Reserve/Check-in Modal -->
<div id="add-reserve" class="hs-overlay hidden ti-modal z-50">
  <div
    class="hs-overlay-open:mt-7 ti-modal-box mt-0 ease-out rounded-2xl shadow-2xl max-w-md w-full mx-auto bg-white dark:bg-neutral-900 border border-gray-100 dark:border-neutral-800">
    <div class="ti-modal-content">
      <div
        class="ti-modal-header flex justify-between items-center p-6 pb-2 border-b border-gray-100 dark:border-neutral-800 rounded-t-2xl bg-gradient-to-r from-blue-100/60 via-white/80 to-white/80 dark:from-neutral-800 dark:to-neutral-900">
        <h6 class="modal-title text-lg font-bold text-primary dark:text-white tracking-wide" id="mail-ComposeLabel">
          <i class="ri-calendar-check-line mr-2 text-blue-400"></i>
          จอง/Check-in
        </h6>
        <button type="button" class="hover:bg-gray/90 dark:hover:bg-neutral-800 rounded-full p-2 ml-2 transition"
          data-hs-overlay="#add-reserve">
          <i class="ri-close-line text-2xl text-gray-500 dark:text-white"></i>
        </button>
      </div>
      <div class="ti-modal-body px-6 py-6 !overflow-visible">
        <app-table-reservation [tableId]="selectedTable?.type === 'table' ? selectedTable?.id : 0"
          [roomId]="selectedTable?.type === 'room' ? selectedTable?.id : 0" [type]="selectedTable?.type"
          (reserve)="reserveTable($event)">
        </app-table-reservation>
      </div>
    </div>
  </div>
</div>
<!-- Bill Modal -->
<div id="view-bill" class="hs-overlay hidden ti-modal z-50" *ngIf="reservation">
  <div
    class="hs-overlay-open:mt-7 ti-modal-box mt-0 ease-out rounded-2xl shadow-2xl max-w-lg w-full mx-auto bg-white dark:bg-neutral-900 border border-gray-100 dark:border-neutral-800">
    <div class="ti-modal-content">
      <div
        class="ti-modal-header flex justify-between items-center p-6 pb-2 border-b border-gray-100 dark:border-neutral-800 rounded-t-2xl bg-gradient-to-r from-teal-100/60 via-white/80 to-white/80 dark:from-neutral-800 dark:to-neutral-900">
        <h6 class="modal-title text-lg font-bold text-teal-600 dark:text-white" id="mail-ComposeLabel">
          <i class="ri-bill-line mr-2 text-teal-400"></i>
          ดูบิล
        </h6>
        <button type="button" class="hover:bg-gray-200 dark:hover:bg-neutral-800 rounded-full p-2 ml-2 transition"
          data-hs-overlay="#view-bill">
          <i class="ri-close-line text-2xl text-gray-500 dark:text-white"></i>
        </button>
      </div>
      <div class="ti-modal-body px-6 py-6 !overflow-visible">
        <app-view-bill [reservation]="reservation" (uploadSlip)="handleUploadSlip($event)"
          (checkOut)="handleCheckOut($event)">
        </app-view-bill>
        <!-- <div class="text-center text-gray-400 dark:text-gray-500">ยังไม่เปิดใช้งาน</div> -->
      </div>
    </div>
  </div>
</div>
